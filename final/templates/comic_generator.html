<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comic Book Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="container">
    <a href="/" class="back-link">&larr; Back to Suite</a>
    <h1>Comic Book Generator</h1>
    
    <form id="comic-form">
        <textarea id="prompt" placeholder="Enter a story idea, e.g., 'A robot discovers gardening on a desolate planet'" required></textarea>
        <button type="submit" class="btn-svg">Generate Comic</button>
    </form>

    <div class="loader" id="loader">
        <p id="loader-status">Generating...</p>
        <small>This can take a minute or two as it generates the story and all panel images.</small>
    </div>

    <div class="output-area">
        <h2 id="comic-title"></h2>
        <div id="comic-output">
            </div>
    </div>
</div>

<script>
    const form = document.getElementById('comic-form');
    const promptInput = document.getElementById('prompt');
    const loader = document.getElementById('loader');
    const loaderStatus = document.getElementById('loader-status');
    const comicTitle = document.getElementById('comic-title');
    const comicOutput = document.getElementById('comic-output');

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        const prompt = promptInput.value.trim();
        if (!prompt) return;

        // Reset UI
        loader.style.display = 'block';
        loaderStatus.textContent = 'Step 1 of 2: Writing the comic script...';
        comicTitle.textContent = '';
        comicOutput.innerHTML = '';

        try {
            const response = await fetch('/generate-comic', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });
            
            // Because this can take a while, we'll update the status
            loaderStatus.textContent = 'Step 2 of 2: Drawing the panels...';

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error || `Server error: ${response.status}`);
            }

            const comicData = await response.json();
            renderComic(comicData);

        } catch (error) {
            console.error('Error:', error);
            comicOutput.innerHTML = `<p style="color:red;">Failed to generate comic: ${error.message}</p>`;
        } finally {
            loader.style.display = 'none';
        }
    });

    // templates/comic_generator.html

function renderComic(data) {
    comicTitle.textContent = data.title || 'Untitled Comic';
    comicOutput.innerHTML = ''; // Clear previous results

    // --- THIS IS THE FIX ---
    // First, check if data.pages exists and is an array.
    if (data.pages && Array.isArray(data.pages)) {
        data.pages.forEach(page => {
            const pageElement = document.createElement('div');
            pageElement.className = 'comic-page';
            
            // Check for panels within the page as well for added safety
            if (page.panels && Array.isArray(page.panels)) {
                page.panels.forEach(panel => {
                    const panelElement = document.createElement('div');
                    panelElement.className = 'comic-panel';
                    
                    const imageWrapper = document.createElement('div');
                    imageWrapper.className = 'panel-image';
                    
                    if (panel.image_url) {
                        const img = document.createElement('img');
                        img.src = panel.image_url;
                        img.alt = panel.description;
                        imageWrapper.appendChild(img);
                    } else {
                        imageWrapper.textContent = 'Image not generated.';
                    }
    
                    let textContent = '';
                    if (panel.caption) {
                        textContent = `<p class="caption">${panel.caption}</p>`;
                    } else if (panel.dialogue) {
                        textContent = `<p class="dialogue">${panel.dialogue}</p>`;
                    }
                    
                    panelElement.appendChild(imageWrapper);
                    panelElement.innerHTML += textContent;
                    pageElement.appendChild(panelElement);
                });
            }

            comicOutput.appendChild(pageElement);
        });
    } else {
        // If data.pages is missing, display a user-friendly error message.
        console.error("Received invalid comic data from server:", data);
        comicOutput.innerHTML = `<p style="color:red; font-weight:bold;">Error: The AI failed to generate a valid comic script. This can happen with complex or unusual prompts. Please try a different prompt.</p>`;
    }
}
</script>

</body>
</html>